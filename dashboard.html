{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h1>üìà Dashboard</h1>
<p>Progress for <strong>{{ today_date }}</strong></p>

<div class="progress-grid" style="margin-bottom: 20px;">
    <div class="progress-metric">
        <div class="label">Calorie Goal</div>
        <div class="value">{{ user.tdee }} <small>kcal</small></div>
    </div>
    <div class="progress-metric">
        <div class="label">Current Weight</div>
        <div class="value">{{ user.weight }} <small>kg</small></div>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Today's Intake</h2>
    
    <div style="margin-bottom: 15px;">
        <div class="progress-label">
            <span>Calories</span>
            <span>{{ totals.calories|int }} / {{ user.tdee|int }} kcal</span>
        </div>
        <div class="progress-bar-container">
            {% set cal_p = ((totals.calories / user.tdee * 100)|round) if user.tdee > 0 else 0 %}
            <div class="progress-bar" style="width: {{ cal_p }}%;"></div>
        </div>
    </div>

    <div style="margin-bottom: 15px;">
        <div class="progress-label">
            <span>Protein</span>
            <span>{{ totals.protein|int }} / {{ user.protein_goal|int }} g</span>
        </div>
        <div class="progress-bar-container">
            {% set pro_p = ((totals.protein / user.protein_goal * 100)|round) if user.protein_goal > 0 else 0 %}
            <div class="progress-bar" style="width: {{ pro_p }}%; background-color: #4CAF50;"></div>
        </div>
    </div>

    <div style="margin-bottom: 15px;">
        <div class="progress-label">
            <span>Carbs</span>
            <span>{{ totals.carbs|int }} / {{ user.carbs_goal|int }} g</span>
        </div>
        <div class="progress-bar-container">
            {% set carb_p = ((totals.carbs / user.carbs_goal * 100)|round) if user.carbs_goal > 0 else 0 %}
            <div class="progress-bar" style="width: {{ carb_p }}%; background-color: #FF9800;"></div>
        </div>
    </div>

    <div style="margin-bottom: 15px;">
        <div class="progress-label">
            <span>Fats</span>
            <span>{{ totals.fat|int }} / {{ user.fat_goal|int }} g</span>
        </div>
        <div class="progress-bar-container">
            {% set fat_p = ((totals.fat / user.fat_goal * 100)|round) if user.fat_goal > 0 else 0 %}
            <div class="progress-bar" style="width: {{ fat_p }}%; background-color: #f44336;"></div>
        </div>
    </div>
</div>

<div class="card">
    <h2 class="card-title">‚öñÔ∏è Log Today's Weight</h2>
    <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
        Updating your weight will automatically recalculate your TDEE and Calorie Goals.
    </p>
    <form id="weight-log-form" style="display: flex; gap: 10px; align-items: flex-end;">
        <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
            <label for="weight-input">Current Weight (kg)</label>
            <input type="number" step="0.1" class="form-input" id="weight-input" name="weight" value="{{ user.weight }}">
        </div>
        <button type="submit" class="btn btn-primary" style="margin-bottom: 0;">Update & Recalculate</button>
    </form>
</div>

<div class="card">
    <h2 class="card-title">Weight History</h2>
    <div style="max-height: 300px; overflow-y: auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Weight (kg)</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in weight_history|reverse %}
                <tr>
                    <td>{{ entry.date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ entry.weight }} kg</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="2" style="text-align: center; color: #888;">No weight logs yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Handle Weight Submission via AJAX
document.getElementById('weight-log-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = this.querySelector('button');
    const originalText = btn.innerText;
    
    btn.disabled = true;
    btn.innerText = "Updating...";

    const formData = new FormData();
    formData.append('weight', document.getElementById('weight-input').value);

    try {
        const response = await fetch("{{ url_for('api_log_weight') }}", {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if(data.success) {
            window.location.reload(); // Reload to show new TDEE and History
        } else {
            alert('Error logging weight: ' + data.error);
            btn.disabled = false;
            btn.innerText = originalText;
        }
    } catch (err) {
        alert('An error occurred connecting to the server.');
        btn.disabled = false;
        btn.innerText = originalText;
    }
});
</script>
{% endblock %}